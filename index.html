/* Watch2EarnReall — app.js (cek-in dihapus → follow channels; task ads tetap 0.01 server) */
(() => {
  // ===== Telegram & API =====
  const tg = window.Telegram?.WebApp;
  tg?.ready?.(); try { tg?.expand?.(); } catch {}
  const API = ""; // isi jika backend beda origin

  // ===== STATE =====
  const state = {
    user: tg?.initDataUnsafe?.user || null,
    balance: 0.00,
    address: localStorage.getItem("bsc_address") || "",
    followDone: new Set(),
  };

  // ===== ELEMENTS =====
  const els = {
    screens: {
      home:      document.getElementById("screen-home"),
      task:      document.getElementById("screen-task"),
      referral:  document.getElementById("screen-referral"),
      profile:   document.getElementById("screen-profile"),
    },
    tabs: document.querySelectorAll(".tabbar .tab"),
    balance: document.getElementById("balance"),

    // FOLLOW (ganti cek-in)
    followList: document.getElementById("followList"),

    // TASKS
    taskRewardLabels: document.querySelectorAll("[data-reward-label]"),

    // PROFILE / WITHDRAW / ADDRESS
    profileAvatar:   document.getElementById("profileAvatar"),
    profileName:     document.getElementById("profileName"),
    profileUsername: document.getElementById("profileUsername"),
    withdrawForm:    document.getElementById("withdrawForm"),
    withdrawAmount:  document.getElementById("withdrawAmount"),
    addressForm:     document.getElementById("addressForm"),
    bscAddress:      document.getElementById("bscAddress"),
  };

  const TASK_REWARD = 0.01;
  const FOLLOW_CHANNELS = Array.isArray(window.FOLLOW_CHANNELS) ? window.FOLLOW_CHANNELS : [];

  // ===== HELPERS =====
  function money(n){ return `$${Number(n).toFixed(2)}`; }
  function setBalance(n){ state.balance = Number(n||0); if (els.balance) els.balance.textContent = money(state.balance); }
  function ensureUser(){
    if (!state.user || !state.user.id) {
      const saved = localStorage.getItem("demo_uid");
      const uid   = saved || String(Math.floor(100000 + Math.random() * 900000));
      if (!saved) localStorage.setItem("demo_uid", uid);
      state.user = { id: uid, first_name: "Guest", username: "guest" };
    }
  }
  async function safeFetch(path, options={}){
    const headers = { "Content-Type":"application/json", ...(options.headers||{}) };
    const init = window.Telegram?.WebApp?.initData || "";
    if (init) headers["x-telegram-init-data"] = init;
    else {
      let uid = localStorage.getItem("demo_uid");
      if (!uid){ uid = String(Math.floor(Math.random()*9e9)+1e9); localStorage.setItem("demo_uid", uid); }
      headers["x-telegram-test-user"] = JSON.stringify({ id: uid, first_name:"Guest", username:"guest" });
    }
    const res = await fetch((API||"")+path, { ...options, headers });
    let data=null; try{ data=await res.json(); }catch{}
    if (!res.ok) throw new Error((data && (data.error||data.message)) || `HTTP ${res.status}`);
    return data || {};
  }

  // ===== Toast (pakai gaya tipis) =====
  let toastTimer=null;
  function toast(msg,type="success"){
    let el=document.getElementById("topToast");
    if(!el){
      const s=document.createElement("style"); s.textContent=`
      #topToast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#111827;color:#e5f2ff;
      border:1px solid #1f2937;border-radius:999px;padding:10px 14px;font-weight:800;z-index:99999;opacity:.98}`;
      document.head.appendChild(s);
      el=document.createElement("div"); el.id="topToast"; el.style.display="none"; document.body.appendChild(el);
    }
    el.textContent=msg; el.style.display="block"; clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>{ el.style.display="none"; },1600);
  }

  // ===== FOLLOW CHANNELS (gantikan cek-in) =====
  function renderFollowList(){
    if (!els.followList) return;
    if (!FOLLOW_CHANNELS.length){
      els.followList.innerHTML = `<div class="muted">No channels configured yet.</div>`;
      return;
    }
    els.followList.innerHTML = FOLLOW_CHANNELS.map(ch=>{
      const done = state.followDone.has(ch.id);
      return `
        <div class="follow-item" data-follow-id="${ch.id}" data-username="${ch.username}">
          <div class="follow-meta">
            <div class="follow-ico">★</div>
            <div>
              <div style="font-weight:900">${ch.title}</div>
              <div class="muted" style="font-size:12px">@${ch.username}</div>
            </div>
          </div>
          <div class="follow-action">
            <span class="pill">$${Number(ch.reward||0.01).toFixed(2)}</span>
            <button class="btn btn-cta btn-join" ${done?'disabled':''}>Join</button>
            <button class="btn btn-verify" ${done?'disabled':''}>Verify</button>
          </div>
        </div>
      `;
    }).join("");
    bindFollowActions();
  }

  function bindFollowActions(){
    els.followList.querySelectorAll(".follow-item").forEach(item=>{
      const fid = item.dataset.followId;
      const username = item.dataset.username;

      item.querySelector(".btn-join")?.addEventListener("click", ()=>{
        try { tg?.openTelegramLink?.(`https://t.me/${username}`); }
        catch { window.open(`https://t.me/${username}`,"_blank"); }
      });

      item.querySelector(".btn-verify")?.addEventListener("click", async ()=>{
        try{
          const start = await safeFetch(`/api/task/create`, {
            method:"POST",
            body: JSON.stringify({ task_id: `follow:${fid}`, type:"follow", channel: username, reward: 0.01 })
          });
          if (!start?.ok || !start.token) return toast(start?.error || "Gagal mulai verifikasi.","error");

          const data = await safeFetch(`/api/reward/complete`, {
            method:"POST",
            body: JSON.stringify({ task_id: `follow:${fid}`, token: start.token, type:"follow" })
          });

          if (data?.credited){
            state.followDone.add(fid);
            item.querySelectorAll("button").forEach(b=> b.disabled = true);
            toast("+$0.01");
            if (typeof data.balance === "number") setBalance(data.balance); else await syncUser();
          } else if (data?.awaiting){
            await new Promise(r=>setTimeout(r, Number(data.wait_seconds||2)*1000));
            const data2 = await safeFetch(`/api/reward/complete`, {
              method:"POST",
              body: JSON.stringify({ task_id: `follow:${fid}`, token: start.token, type:"follow" })
            });
            if (data2?.credited){
              state.followDone.add(fid);
              item.querySelectorAll("button").forEach(b=> b.disabled = true);
              toast("+$0.01");
              if (typeof data2.balance === "number") setBalance(data2.balance); else await syncUser();
            } else { toast(data2?.error || "Belum terdeteksi join.","error"); }
          } else {
            toast(data?.error || "Belum terdeteksi join.","error");
          }
        } catch { toast("Failed to reach server.","error"); }
      });
    });
  }

  // ===== TASKS (watch ads) — reward 0.01 dari server =====
  function paintTaskRewardLabels(){ els.taskRewardLabels?.forEach(el=> el.textContent = `$${TASK_REWARD.toFixed(2)}`); }
  function initTasks(){
    paintTaskRewardLabels();
    document.querySelectorAll(".task-card .btn-cta[data-action='watch']").forEach(btn=>{
      if (btn.__bound) return; btn.__bound = true;
      btn.addEventListener("click", async ()=>{
        try{
          const card = btn.closest(".task-card");
          const taskId = card?.dataset?.taskId;
          if (!taskId) return;

          try { const fn = window[window.MONETAG_FN]; if (typeof fn === "function") fn(); } catch {}

          const start = await safeFetch(`/api/task/create`, {
            method: "POST",
            body: JSON.stringify({ task_id: taskId, reward: TASK_REWARD })
          });
          if (!start?.ok || !start.token) return toast(start?.error || "Gagal mulai task.","error");

          const token = start.token;
          const waitSec = Number(start.wait_seconds || 16);
          await new Promise(r => setTimeout(r, waitSec * 1000));

          async function complete(){
            const data = await safeFetch(`/api/reward/complete`, {
              method:"POST",
              body: JSON.stringify({ task_id: taskId, token, reward: TASK_REWARD })
            });
            if (data?.credited){
              btn.disabled = true;
              toast("+$0.01");
              if (typeof data.balance === "number") setBalance(data.balance); else await syncUser();
              return;
            }
            if (data?.awaiting && data.wait_seconds>0){
              await new Promise(r=>setTimeout(r, Number(data.wait_seconds)*1000));
              return complete();
            }
            toast(data?.error || "Verification failed.","error");
          }
          await complete();
        } catch { toast("Failed to reach server.","error"); }
      });
    });
  }

  // ===== PROFILE / WITHDRAW / ADDRESS (tak diubah) =====
  function setProfile(){
    try{
      const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
      state.user = u || state.user;
      if (els.profileAvatar)   els.profileAvatar.src = u?.photo_url || "assets/images/avatar.svg";
      if (els.profileName)     els.profileName.textContent = u?.first_name || "Guest";
      if (els.profileUsername) els.profileUsername.textContent = u?.username ? `@${u.username}` : "—";
    } catch {}
  }
  function initWithdrawForm(){
    els.withdrawForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const amount = Number(els.withdrawAmount.value || 0);
      if (!amount || amount < 1) return toast("Minimum withdraw is $1.00","error");
      try{
        const data = await safeFetch(`/api/withdraw`, { method:"POST", body: JSON.stringify({ amount, address: state.address }) });
        if (data?.ok){ toast("Withdrawal request submitted."); els.withdrawAmount.value = ""; }
        else { toast(data?.error || "Withdraw failed.","error"); }
      } catch { toast("Failed to reach server.","error"); }
    });
  }
  function initAddressForm(){
    els.addressForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const addr = (els.bscAddress.value || "").trim();
      if (!/^0x[a-fA-F0-9]{40}$/.test(addr)) return toast("Invalid BEP20 address.","error");
      state.address = addr; localStorage.setItem("bsc_address", addr);
      try{
        await safeFetch(`/api/address/save`, { method:"POST", body: JSON.stringify({ address: addr }) });
        toast("Address saved.");
      } catch { toast("Failed to save address.","error"); }
    });
  }

  // ===== NAV =====
  function setScreen(name){
    Object.entries(els.screens).forEach(([k, el]) => el?.classList.toggle("active", k === name));
    els.tabs.forEach(tab => tab.classList.toggle("active", tab.dataset.target === name));
  }
  function initTabs(){ els.tabs.forEach(tab => tab.addEventListener("click", () => setScreen(tab.dataset.target))); }

  // ===== USER SYNC =====
  async function syncUser(){
    try{
      const data = await safeFetch(`/api/user/get`);
      const u = (data && data.user) ? data.user : data;
      if (u && typeof u.balance === "number") setBalance(u.balance);
      if (Array.isArray(u?.follow_done)) u.follow_done.forEach(id=> state.followDone.add(id));
      renderFollowList();
    } catch {}
  }

  // ===== INIT =====
  function init(){
    ensureUser();
    setProfile();
    setBalance(state.balance);

    initTabs();
    renderFollowList();
    initTasks();
    initWithdrawForm();
    initAddressForm();

    syncUser();

    document.body.dataset.tg = tg?.colorScheme || "light";
  }

  // expose
  window.safeFetch = safeFetch;
  window.setBalance = setBalance;
  window.syncUser = syncUser;

  init();
})();
