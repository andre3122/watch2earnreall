<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Watch2EarnReall â€” Telegram Mini App</title>
  <meta name="theme-color" content="#12d8fa"/>
  <meta name="color-scheme" content="light only"/>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag Mini App SDK (SET) -->
  <script src="//libtl.com/sdk.js" data-zone="9726748" data-sdk="show_9726748"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://unpkg.com/@fontsource/poppins@5.0.8/400.css" rel="stylesheet">
  <link href="https://unpkg.com/@fontsource/poppins@5.0.8/600.css" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/styles.css"/>
</head>
<body>
  <div id="app" class="app">
    <header class="app-header">
      <div class="brand">
        <div class="logo-glow"></div>
        <span class="brand-title">Watch2Earn<span class="accent">Reall</span></span>
      </div>
      <div class="coins">
        <span id="balance">$0.00</span>
      </div>
    </header>

    <main class="screens">
      <section id="screen-home" class="screen active">
        <div class="follow-card glass card">
  <h3>Follow Our Channel</h3>
  <p class="muted">Join our Telegram channel and get instant reward.</p>

  <ul class="follow-steps" style="display:grid;gap:10px;margin:10px 0 14px;padding:0;">
    <li style="list-style:none;display:flex;gap:10px;align-items:flex-start;background:#f9fafb;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px;">
      <div class="ico" style="width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#eef2ff;font-weight:900;">1</div>
      <div>Tap <b>Open Channel</b> to open our official channel.</div>
    </li>
    <li style="list-style:none;display:flex;gap:10px;align-items:flex-start;background:#f9fafb;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px;">
      <div class="ico" style="width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#eef2ff;font-weight:900;">2</div>
      <div>Tap <b>Join</b> in Telegram.</div>
    </li>
    <li style="list-style:none;display:flex;gap:10px;align-items:flex-start;background:#f9fafb;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px;">
      <div class="ico" style="width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#eef2ff;font-weight:900;">3</div>
      <div>Return here and press <b>Verify</b> to receive your reward.</div>
    </li>
  </ul>

  <div class="btn-row" style="display:flex;gap:10px;">
    <button id="btnOpenChannel" class="btn" style="flex:1 1 auto;">Open Channel</button>
    <button id="btnVerifyFollow" class="btn" style="flex:1 1 auto;background:linear-gradient(90deg,#12d8fa,#00c6ff);color:#fff;font-weight:800;">Verify</button>
  </div>
  <div class="muted" id="followHint" style="font-size:12px;margin-top:6px;">Reward is credited once per account.</div>
</div>

<!-- home-ref-card: ubah teks 25% â†’ 10% -->
<div class="home-ref-card">
  <h3>Invite Friends & Earn</h3>
  <p class="muted">Get 10% of their earnings</p>
  <button id="btnHomeRefer" class="btn btn-ref-home">Start Referring</button>
</div>

        <div class="home-ref-card">
          <h3>Invite Friends & Earn</h3>
          <p class="muted">Get 10% of their earnings</p>
          <button id="btnHomeRefer" class="btn btn-ref-home">Start Referring</button>
        </div>
      
      </section>
      <section id="screen-task" class="screen">
        <div class="section-title">
          <p class="muted">Complete the tasks to earn rewards. Verification is done on the server.</p>
        </div>

        <div class="tasks-list">
          <article class="task-card neon-border" data-task-id="ad1">
            <div class="task-left">
              <div class="task-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"></path></svg></div>
              <div class="task-meta">
                <h3>Watch Ad #1</h3>
                <p class="muted">Duration ~15â€“30 sec â€¢ Reward after validation</p>
              </div>
            </div>
            <div class="task-right"><button class="btn btn-cta" data-action="watch">Watch Ad</button></div>
          </article>

          <article class="task-card neon-border" data-task-id="ad2">
            <div class="task-left">
              <div class="task-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13 2l1.5 6L21 9l-6 1.5L13 17l-1.5-6L5 9l6-1.5L13 2z"></path></svg></div>
              <div class="task-meta">
                <h3>Watch Ad #2</h3>
                <p class="muted">Duration ~15â€“30 sec â€¢ Reward after validation</p>
              </div>
            </div>
            <div class="task-right"><button class="btn btn-cta" data-action="watch">Watch Ad</button></div>
          </article>
        </div>

        <div class="legend">
          <small>Note: After the ad finishes, the server will verify before adding your balance.</small>
        </div>
      </section>

      <section id="screen-referral" class="screen">
        <div class="ref-hero glass card">
          <div class="ref-hero-head">
            <h2>Refer & Earn Forever</h2>
            <div class="ref-badge">25%</div>
          </div>
          <p class="muted">Earn <strong>25%</strong> of your friends earnings for life! Follow these simple steps to start:</p>

          <ul class="ref-steps">
            <li>
              <div class="ref-ico">ðŸ”—</div>
              <div><strong>1. Copy Your Link</strong><br><small>Grab your unique referral link below.</small></div>
            </li>
            <li>
              <div class="ref-ico">ðŸ“£</div>
              <div><strong>2. Share with Friends</strong><br><small>Use the Telegram, WhatsApp, or Twitter/X buttons to share.</small></div>
            </li>
            <li>
              <div class="ref-ico">ðŸ’°</div>
              <div><strong>3. Earn Lifetime Rewards</strong><br><small>Get 25% of your friends earnings forever once they join!</small></div>
            </li>
          </ul>

          <h3 class="ref-subtitle">Your Referral Link</h3>
          <div class="ref-input-group">
            <input id="refLink" readonly value="Generatingâ€¦"/>
            <button id="btnCopyRef" class="btn copy-pill">Copy</button>
          </div>

          <div class="ref-share-buttons">
            <button id="btnShareTG" class="btn brand tg">Telegram</button>
            <button id="btnShareWA" class="btn brand wa">WhatsApp</button>
            <button id="btnShareTW" class="btn brand tw">Twitter/X</button>
          </div>
        </div>

        <div class="glass card ref-list-card">
          <div class="ref-list-head">
            <h3>Referrals</h3>
            <div class="ref-count-badge"><span id="refCount">0</span></div>
          </div>
          <div class="ref-search-row">
            <input id="refSearch" placeholder="Search referrals by usernameâ€¦"/>
          </div>
          <div id="refList" class="ref-empty">Your referrals will appear here.</div>
        </div>
      </section>

      <section id="screen-profile" class="screen">
        <div class="profile-top">
          <div class="profile-avatar" id="profileAvatar" title="Telegram Profile"></div>
          <div class="profile-id">
            <div id="profileName" class="profile-name">User</div>
            <div id="profileUsername" class="profile-username">@username</div>
          </div>
        </div>

        <div class="glass card" id="withdrawCard">
          <form id="withdrawForm" class="form">
            <label for="withdrawAmount">Amount Withdraw (USD)</label>
            <input id="withdrawAmount" name="amount" type="number" inputmode="decimal" min="1" step="0.01" placeholder="1.00" required />
            <small class="muted">Minimum withdraw 1$</small>
            <button class="btn btn-primary" type="submit" style="display:none">Submit Withdraw</button>
          </form>

          <!-- address form akan dipindah ke card ini via JS -->
        </div>

        <div class="glass card" id="addressCard">
          <form id="addressForm" class="form">
            <label for="bscAddress">Address (BSC BEP20)</label>
            <input id="bscAddress" name="address" type="text" placeholder="your address 0x.. or binance id" pattern="^0x[a-fA-F0-9]40$" required />
            <small class="muted">Submit your address or binance id.</small>
            <button class="btn" type="submit">Simpan Alamat</button>
          </form>
        </div>
      </section>
    </main>

    <nav class="tabbar">
      <button class="tab active" data-target="home" aria-label="Home">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
        <span>Home</span>
      </button>
      <button class="tab" data-target="task" aria-label="Task">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 11h8v2H9v-2zm0 4h8v2H9v-2zM7 7h10v2H7V7z"/></svg>
        <span>Task</span>
      </button>
      <button class="tab" data-target="referral" aria-label="Referral">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0C9.66 11 11 9.66 11 8S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-2.66-5.33-4-8-4zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v2H24v-2c0-2.66-5.33-4-8-4z"/></svg>
        <span>Referral</span>
      </button>
      <button class="tab" data-target="profile" aria-label="Profile">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>
        <span>Profil</span>
      </button>
    </nav>
  </div>

  <script src="./config.js"></script>

  <!-- Patch fetch: inject x-telegram-init-data untuk semua /api pada origin yang sama -->
  <script>
    (function () {
      function getInitData(){ try{ return Telegram?.WebApp?.initData || '' }catch{ return '' } }
      const _fetch = window.fetch;
      window.fetch = function(input, init){
        try{
          const urlStr = (typeof input === 'string') ? input : (input && input.url) || '';
          const u = new URL(urlStr, location.href);
          if (u.origin === location.origin && u.pathname.startsWith('/api/')) {
            const headers = new Headers((init && init.headers) || (typeof input !== 'string' ? input.headers : undefined) || {});
            const id = getInitData();
            if (id && !headers.has('x-telegram-init-data')) headers.set('x-telegram-init-data', id);
            init = Object.assign({}, init, { headers });
          }
        }catch{}
        return _fetch(input, init);
      };
    })();
  </script>

  <!-- === CHECK-IN (smooth, anti-flicker, cache-aware) === -->
  <!-- === FOLLOW CHANNEL glue (gantikan blok CHECK-IN) === -->
<script>
(function(){
  const CHANNEL = '@YourChannelUsername';           // TODO: ganti @channel kamu
  const TASK_ID = `follow:${CHANNEL}`;              // dikenali server

  const balEl = document.getElementById('balance');
  const openBtn = document.getElementById('btnOpenChannel');
  const verifyBtn = document.getElementById('btnVerifyFollow');
  const hint = document.getElementById('followHint');

  function toast(m){ try{Telegram.WebApp.showAlert(m);}catch{alert(m);} }

  openBtn?.addEventListener('click', () => {
    const slug = CHANNEL.replace(/^@/, '');
    try { Telegram.WebApp.openLink(`https://t.me/${slug}`); }
    catch { location.href = `https://t.me/${slug}`; }
  });

  verifyBtn?.addEventListener('click', async () => {
    if (verifyBtn.classList.contains('is-done')) return;
    verifyBtn.disabled = true; verifyBtn.textContent = 'Verifyingâ€¦';
    try{
      const r = await fetch('/api/reward/complete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ task_id: TASK_ID })
      });
      const j = await r.json();

      if (j.ok && j.credited){
        if (balEl && j.balance!=null) balEl.textContent = `$${Number(j.balance).toFixed(2)}`;
        verifyBtn.textContent = 'Verified âœ“';
        verifyBtn.classList.add('is-done');
        hint && (hint.textContent = 'You have received the reward. Thank you!');
        verifyBtn.disabled = false;
        return;
      }
      if (j.ok && j.already){
        verifyBtn.textContent = 'Verified âœ“';
        verifyBtn.classList.add('is-done');
        verifyBtn.disabled = false;
        return;
      }
      if (j.error === 'NOT_MEMBER'){
        verifyBtn.textContent = 'Verify';
        verifyBtn.disabled = false;
        return toast('Please join the channel first, then try Verify again.');
      }
      verifyBtn.textContent = 'Verify';
      verifyBtn.disabled = false;
      toast(j.error || 'Verification failed');
    }catch(e){
      verifyBtn.textContent = 'Verify';
      verifyBtn.disabled = false;
      toast('Failed to reach server');
    }
  });

  // (opsional) sinkron UI % referral dari server
  (async function syncRefPct(){
    try{
      const r = await fetch('/api/user/get'); const j = await r.json();
      const rp = Number(j.ref_percent || 10);
      const badge = document.querySelector('.ref-badge'); if (badge) badge.textContent = `${rp}%`;
      const home  = document.querySelector('.home-ref-card .muted'); if (home) home.textContent = `Get ${rp}% of their earnings`;
      const hero  = document.querySelector('.ref-hero p.muted'); if (hero) hero.innerHTML = `Earn <strong>${rp}%</strong> of your friends earnings for life!`;
    }catch{}
  })();
})();
</script>
          

  <!-- === TASK IKLAN (tetap) === -->
  <script>
    (function(){
      const bal=document.getElementById('balance');

      function setBusy(btn,v){ if(!btn)return; btn.toggleAttribute('disabled', !!v); btn.dataset.busy=v?'1':''; }
      function setLabel(btn,t){ if(!btn)return; if(!btn.dataset.prev) btn.dataset.prev=btn.textContent; btn.textContent=t; }
      function resetLabel(btn){ if(!btn)return; const p=btn.dataset.prev; if(p) btn.textContent=p; delete btn.dataset.prev; }

      function getMonetagFn(){
        const s=document.querySelector('script[src*="libtl.com/sdk.js"]');
        const name=s?.getAttribute('data-sdk')||'';
        const fn= name && window[name];
        return (typeof fn==='function') ? fn : null;
      }
      function showAdWithTimeout(ms=3000){
        return new Promise(resolve=>{
          let tried=0, done=false;
          (function tick(){
            const fn=getMonetagFn();
            if (fn){ try{ fn(); done=true; return resolve(true);}catch{ return resolve(false);} }
            if (++tried*200 >= ms) return resolve(false);
            setTimeout(tick,200);
          })();
          setTimeout(()=>{ if(!done) resolve(false); }, ms+600);
        });
      }

      async function watchTask(taskId, btn){
        if (btn?.dataset.busy==='1') return;
        setBusy(btn,true); setLabel(btn,'Startingâ€¦');

        try{
          // Tampilkan iklan (jika SDK siap)
          await showAdWithTimeout(3000);

          // Buat sesi
          const r1=await fetch('/api/task/create',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ task_id: taskId })
          });
          const c1=await r1.json();
          if (!c1.ok){ setLabel(btn,'Failed'); return; }

          // Countdown
          let left=Number(c1.wait_seconds||16);
          while(left>0){ setLabel(btn,`Watching ${left}s`); await new Promise(r=>setTimeout(r,1000)); left--; }
          setLabel(btn,'Verifyingâ€¦');

          // Verifikasi & update balance
          for(let i=0;i<10;i++){
            const r2=await fetch('/api/reward/complete',{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ task_id: taskId, token: c1.token })
            });
            const j=await r2.json();

            if (j.awaiting && j.wait_seconds){
              let w=Number(j.wait_seconds);
              while(w>0){ setLabel(btn,`Verifying ${w}s`); await new Promise(r=>setTimeout(r,1000)); w--; }
              continue;
            }
            if (j.credited){
              if (bal && j.balance!=null) bal.textContent=`$${Number(j.balance).toFixed(2)}`;
              setLabel(btn,'Done âœ“'); setTimeout(()=>{ resetLabel(btn); setBusy(btn,false); }, 1200);
              return;
            }
            await new Promise(r=>setTimeout(r,1000));
          }
          setLabel(btn,'Try again');
        }catch(e){
          setLabel(btn,'Error');
        }finally{
          setTimeout(()=>{ resetLabel(btn); setBusy(btn,false); }, 1500);
        }
      }

      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.task-card [data-action="watch"]').forEach(function(btn){
          const card=btn.closest('.task-card');
          const taskId=card?.getAttribute('data-task-id')||'ad1';
          btn.addEventListener('click', ()=>watchTask(taskId, btn), {capture:false});
        });
      });
    })();
  </script>

  <script>
/* WITHDRAW: gabung form + tombol bawah + inject Riwayat */
(function () {
  const wForm = document.getElementById('withdrawForm');
  const aForm = document.getElementById('addressForm');
  const wCard = document.getElementById('withdrawCard');
  const aCard = document.getElementById('addressCard');
  if (!wForm || !aForm || !wCard || !aCard) return;

  // 1) gabungkan card
  aForm.style.marginTop = '16px';
  wCard.appendChild(aForm);
  aCard.remove();

  // 2) proxy tombol submit (bawah)
  const wBtn = wForm.querySelector('button[type="submit"]');
  if (wBtn) wBtn.style.display = 'none';
  const aBtn = aForm.querySelector('button[type="submit"]');
  if (aBtn){
    aBtn.textContent = 'Submit Withdraw';
    aBtn.type = 'button';
    aBtn.id = 'btnWithdrawProxy';
    aBtn.onclick = function(){
      if (wForm.reportValidity && !wForm.reportValidity()) return;
      if (wForm.requestSubmit) wForm.requestSubmit(); else wForm.submit();
    };
  }

  // 3) inject kartu Riwayat (tanpa edit HTML)
  let histCard = document.getElementById('wdHistoryCard');
  if (!histCard){
    histCard = document.createElement('div');
    histCard.className = 'glass card';
    histCard.id = 'wdHistoryCard';
    histCard.innerHTML = `
      <h3>Withdraw History</h3>
      <div id="wdHistoryList" class="wd-list empty">No history yet.</div>
    `;
    wCard.parentNode.appendChild(histCard);
  }
  const listEl = document.getElementById('wdHistoryList');

  function fmtDate(iso){ try{ return new Date(iso).toLocaleString(); }catch{return iso||'';} }
  function badge(status){
    const s = String(status||'').toLowerCase();
    const cls = s==='approved' ? 'approved' : (s==='rejected' ? 'rejected' : 'pending');
    return `<span class="wd-badge ${cls}">${s||'pending'}</span>`;
  }

  async function fetchWithdrawHistory(){
    try{
      const r = await fetch('/api/withdraw/request');        // GET = history
      const j = await r.json();
      const items = Array.isArray(j?.items) ? j.items : [];
      if (!listEl) return;
      if (!items.length){
        listEl.classList.add('empty');
        listEl.innerHTML = 'No history yet.';
        return;
      }
      listEl.classList.remove('empty');
      listEl.innerHTML = items.map(row => `
        <div class="row">
          <div>
            <div class="amt">-$${Number(row.amount||0).toFixed(2)}</div>
            <div class="meta">${fmtDate(row.created_at)}</div>
          </div>
          <div>${badge(row.status)}</div>
        </div>
      `).join('');
    }catch{}
  }

  // 4) refresh riwayat setelah submit sukses
  wForm.addEventListener('submit', async (e) => {
    // handler submit kamu yang sekarang akan tetap jalan (di app.js),
    // tapi kita juga hook di sini kalau ada yang submit via proxy langsung:
    setTimeout(fetchWithdrawHistory, 800);
  });

  // initial load
  fetchWithdrawHistory();
})();
</script>

<style>
  /* Tombol biru terang */
  #btnWithdrawProxy{
    background: linear-gradient(90deg, #12d8fa, #00c6ff);
    color:#fff !important; border:none; font-weight:600;
    box-shadow:0 8px 24px rgba(0,198,255,.35);
  }
  #btnWithdrawProxy:active{ transform: translateY(1px); }
  #btnWithdrawProxy:disabled{ opacity:.65; }

  /* Riwayat */
  #wdHistoryCard h3{ margin-bottom:8px; }
  .wd-list .row{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 0; border-bottom:1px dashed rgba(0,0,0,.06);
  }
  .wd-list .amt{ font-weight:800; }
  .wd-list .meta{ color:var(--muted,#6b7280); font-size:12px; }
  .wd-badge{
    padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px;
    background:#eef2f7; border:1px solid rgba(0,0,0,.06);
  }
  .wd-badge.pending{  background:#fff7e6; border-color:#ffd18a; color:#a86b00; }
  .wd-badge.approved{ background:#e9ffef; border-color:#88e09d; color:#0c7a2b; }
  .wd-badge.rejected{ background:#ffe9ec; border-color:#ff9aa6; color:#b11d2a; }
</style>

<script>
/* Withdraw sekali klik: kirim amount + address langsung ke /api/withdraw/request */
(function () {
  const amountEl = document.getElementById('withdrawAmount');
  const addrEl   = document.getElementById('bscAddress');
  const balEl    = document.getElementById('balance');

  // tombol bawah hasil merge card (id btnWithdrawProxy) atau fallback tombol addressForm
  const btn = document.getElementById('btnWithdrawProxy')
          || document.querySelector('#addressForm button[type="submit"]');
  if (!amountEl || !addrEl || !btn) return;

  addrEl.setAttribute('pattern','^(0x[0-9a-fA-F]{40}|[A-Za-z0-9._-]{6,})$');

  function toast(m){ try{Telegram.WebApp.showAlert(m);}catch{alert(m);} }

  btn.onclick = async () => {
    const amount  = Number(amountEl.value);
    const address = (addrEl.value || '').trim();

    if (!amount || amount < 1)  return toast('Minimum withdraw $1');
    if (!address)               return toast('Fill your BEP20 address or Binance id.');

    btn.disabled = true;
    try {
      const r = await fetch('/api/withdraw/request', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ amount, address })
      });
      const j = await r.json();

      if (!j.ok) {
        btn.disabled = false;
        return toast(j.error || 'Withdraw failed');
      }
      if (balEl && j.balance != null) {
        balEl.textContent = `$${Number(j.balance).toFixed(2)}`;
      }
      toast('Withdraw request submitted âœ…');
    } catch (e) {
      btn.disabled = false;
      toast('Failed to reach server');
    }
  };
})();
</script>

  <script src="./app.js" defer></script>
<script>
(function(){
  async function refreshUserBasics(){
    try{
      const r = await fetch('/api/user/get');
      const j = await r.json();
      if (!j.ok) return;

      // saldo header
      const balEl = document.getElementById('balance');
      if (balEl && j.user && j.user.balance != null) {
        balEl.textContent = `$${Number(j.user.balance).toFixed(2)}`;
      }

      // referral percent UI (default 10%)
      const rp = Number(j.ref_percent || 10);
      const badge = document.querySelector('.ref-badge'); if (badge) badge.textContent = `${rp}%`;
      const home  = document.querySelector('.home-ref-card .muted'); if (home) home.textContent = `Get ${rp}% of their earnings`;
      const hero  = document.querySelector('.ref-hero p.muted'); if (hero) hero.innerHTML = `Earn <strong>${rp}%</strong> of your friends earnings for life!`;
    }catch{}
  }

  // panggil saat load
  document.addEventListener('DOMContentLoaded', refreshUserBasics);
  // opsional: expose biar bisa dipanggil dari tempat lain
  window.refreshUserBasics = refreshUserBasics;
})();
</script>

</body>
</html>
