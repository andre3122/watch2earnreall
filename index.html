<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Watch2EarnReall ‚Äî Telegram Mini App</title>
  <meta name="theme-color" content="#12d8fa"/>
  <meta name="color-scheme" content="light only"/>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Monetag Mini App SDK (SET) -->
  <script src="//libtl.com/sdk.js" data-zone="9726748" data-sdk="show_9726748"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://unpkg.com/@fontsource/poppins@5.0.8/400.css" rel="stylesheet">
  <link href="https://unpkg.com/@fontsource/poppins@5.0.8/600.css" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/styles.css"/>
</head>
<body>
  <div id="app" class="app">
    <header class="app-header">
      <div class="brand">
        <div class="logo-glow"></div>
        <span class="brand-title">Watch2Earn<span class="accent">Reall</span></span>
      </div>
      <div class="coins">
        <span id="balance">$0.00</span>
      </div>
    </header>

    <main class="screens">
      <section id="screen-home" class="screen active">
  <div class="checkin-card">
    <h2 class="checkin-title">Daily Check-in Bonus</h2>
    <p class="muted">Claim your daily reward and keep your streak!</p>

    <!-- Kotak-kotak check-in -->
    <div class="checkin-tiles" id="checkinTiles"><!-- diisi via JS --></div>

    <!-- Progress bar -->
    <div class="checkin-progress">
      <div class="checkin-progress-bar" id="checkinProgressBar"></div>
    </div>

    <!-- Tombol CLAIM -->
    <button class="btn btn-claim" id="btnClaim">
      <span class="gift" aria-hidden="true">üéÅ</span>
      <span id="claimText">Claim Bonus</span>
    </button>
  </div>

  <!-- Kartu Referral di Home -->
  <div class="home-ref-card">
    <h3>Invite Friends & Earn</h3>
    <p class="muted">Get 25% of their earnings</p>
    <button id="btnHomeRefer" class="btn btn-ref-home">Start Referring</button>
  </div>
</section>


      <section id="screen-task" class="screen">
        <div class="section-title">
          <h2>Task Nonton Iklan</h2>
          <p class="muted">Selesaikan task untuk mendapatkan reward. Verifikasi dilakukan dari server.</p>
        </div>

        <div class="tasks-list">
          <article class="task-card neon-border" data-task-id="ad1">
            <div class="task-left">
              <div class="task-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"></path></svg></div>
              <div class="task-meta">
                <h3>Nonton Iklan #1</h3>
                <p class="muted">Durasi ~15-30 detik ‚Ä¢ Reward setelah valid</p>
              </div>
            </div>
            <div class="task-right"><button class="btn btn-cta" data-action="watch">Watch Ad</button></div>
          </article>

          <article class="task-card neon-border" data-task-id="ad2">
            <div class="task-left">
              <div class="task-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13 2l1.5 6L21 9l-6 1.5L13 17l-1.5-6L5 9l6-1.5L13 2z"></path></svg></div>
              <div class="task-meta">
                <h3>Nonton Iklan #2</h3>
                <p class="muted">Durasi ~15-30 detik ‚Ä¢ Reward setelah valid</p>
              </div>
            </div>
            <div class="task-right"><button class="btn btn-cta" data-action="watch">Watch Ad</button></div>
          </article>
        </div>

        <div class="legend">
          <small>Catatan: Setelah iklan selesai, sistem akan verifikasi ke server sebelum menambah saldo.</small>
        </div>
      </section>
<section id="screen-referral" class="screen">
  <!-- HERO CARD -->
  <div class="ref-hero glass card">
    <div class="ref-hero-head">
      <h2>Refer & Earn Forever</h2>
      <div class="ref-badge">25%</div>
    </div>
    <p class="muted">Earn <strong>25%</strong> of your friends earnings for life! Follow these simple steps to start:</p>

    <ul class="ref-steps">
      <li>
        <div class="ref-ico">üîó</div>
        <div><strong>1. Copy Your Link</strong><br><small>Grab your unique referral link below.</small></div>
      </li>
      <li>
        <div class="ref-ico">üì£</div>
        <div><strong>2. Share with Friends</strong><br><small>Use the Telegram, WhatsApp, or Twitter/X buttons to share.</small></div>
      </li>
      <li>
        <div class="ref-ico">üí∞</div>
        <div><strong>3. Earn Lifetime Rewards</strong><br><small>Get 25% of your friends earnings forever once they join!</small></div>
      </li>
    </ul>

    <h3 class="ref-subtitle">Your Referral Link</h3>
    <div class="ref-input-group">
      <input id="refLink" readonly value="Generating‚Ä¶"/>
      <button id="btnCopyRef" class="btn copy-pill">Copy</button>
    </div>

    <div class="ref-share-buttons">
      <button id="btnShareTG" class="btn brand tg">Telegram</button>
      <button id="btnShareWA" class="btn brand wa">WhatsApp</button>
      <button id="btnShareTW" class="btn brand tw">Twitter/X</button>
    </div>
  </div>

  <!-- LIST CARD -->
  <div class="glass card ref-list-card">
    <div class="ref-list-head">
      <h3>Referrals</h3>
      <div class="ref-count-badge"><span id="refCount">0</span></div>
    </div>
    <div class="ref-search-row">
      <input id="refSearch" placeholder="Search referrals by username‚Ä¶"/>
    </div>
    <div id="refList" class="ref-empty">Your referrals will appear here.</div>
  </div>
</section>
      
      
      <section id="screen-profile" class="screen">
        <div class="profile-top">
          <div class="profile-avatar" id="profileAvatar" title="Telegram Profile"></div>
          <div class="profile-id">
            <div id="profileName" class="profile-name">User</div>
            <div id="profileUsername" class="profile-username">@username</div>
          </div>
        </div>

        <div class="glass card">
          <form id="withdrawForm" class="form">
            <label for="withdrawAmount">Amount Withdraw (USD)</label>
            <input id="withdrawAmount" name="amount" type="number" inputmode="decimal" min="1" step="0.01" placeholder="1.00" required />
            <small class="muted">Minimum withdraw 1$</small>
            <button class="btn btn-primary" type="submit">Submit Withdraw</button>
          </form>
        </div>

        <div class="glass card">
          <form id="addressForm" class="form">
            <label for="bscAddress">Address (BSC BEP20)</label>
            <input id="bscAddress" name="address" type="text" placeholder="0x..." pattern="^0x[a-fA-F0-9]40$" required />
            <small class="muted">Masukkan alamat dompet BEP20 kamu.</small>
            <button class="btn" type="submit">Simpan Alamat</button>
          </form>
        </div>
      </section>
    </main>

    <nav class="tabbar">
      <button class="tab active" data-target="home" aria-label="Home">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
        <span>Home</span>
      </button>
      <button class="tab" data-target="task" aria-label="Task">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 11h8v2H9v-2zm0 4h8v2H9v-2zM7 7h10v2H7V7z"/></svg>
        <span>Task</span>
      </button>
      <button class="tab" data-target="referral" aria-label="Referral">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0C9.66 11 11 9.66 11 8S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-2.66-5.33-4-8-4zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v2H24v-2c0-2.66-5.33-4-8-4z"/></svg>
        <span>Referral</span>
      </button>
      <button class="tab" data-target="profile" aria-label="Profile">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>
        <span>Profil</span>
      </button>
    </nav>
  </div>

  <script src="./config.js"></script>

  <!-- Inject header initData ke semua fetch('/api/*') -->
  <script>
  (function () {
    function getInitData() {
      try { return window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData || ''; }
      catch(e){ return ''; }
    }
    const _fetch = window.fetch;
    window.fetch = function (input, init) {
      try {
        const url = (typeof input === 'string' ? input : input.url) || '';
        if (url.startsWith('/api/')) {
          const headers = new Headers((init && init.headers) || {});
          const id = getInitData();
          if (id && !headers.has('x-telegram-init-data')) {
            headers.set('x-telegram-init-data', id);
          }
          init = Object.assign({}, init, { headers });
        }
      } catch (e) {}
      return _fetch(input, init);
    };
  })();
  </script>

  <!-- GLUE: Daily Check-in (kirim POST + update saldo/label) -->
  <script>
  (function () {
    const btn = document.getElementById('btnClaim');
    if (!btn) return;

    const txt = document.getElementById('claimText');
    const bal = document.getElementById('balance');

    function toast(msg){
      try { Telegram.WebApp.showAlert(msg); } catch { alert(msg); }
    }

    btn.addEventListener('click', async () => {
      btn.disabled = true;
      try {
        const r = await fetch('/api/checkin/claim', { method: 'POST' });
        const j = await r.json();

        if (!j.ok) {
          btn.disabled = false;
          return toast(j.error || 'Claim gagal');
        }

        if (bal && j.balance != null) {
          bal.textContent = `$${Number(j.balance).toFixed(2)}`;
        }
        if (txt) txt.textContent = j.already ? 'Sudah di-claim' : 'Claimed!';
        btn.classList.add('is-claimed');
      } catch (e) {
        btn.disabled = false;
        toast('Failed to reach server');
      }
    });
  })();
  </script>
<script>
(function(){
  const SCHEDULE = ["0.02","0.04","0.06","0.08","0.10","0.12","0.14","0.16","0.18"];
  const tilesEl = document.getElementById('checkinTiles');
  const btn = document.getElementById('btnClaim');
  const btnTxt = document.getElementById('claimText');
  const balEl = document.getElementById('balance');

  function toast(m){ try{Telegram.WebApp.showAlert(m);}catch{alert(m);} }

  function renderTiles(streak, already){
    // day yang sudah selesai = streak (kalau belum klaim hari ini)
    // kalau sudah klaim hari ini, day=streak (termasuk hari ini)
    const done = Number(streak || 0);
    let html = '';
    for (let i=1;i<=9;i++){
      const amount = SCHEDULE[i-1];
      const claimed = (i <= done);
      const cls = claimed ? 'tile claimed' : (i===Math.min(done+1,9) ? 'tile current' : 'tile locked');
      html += `
        <div class="${cls}" data-day="${i}">
          <div class="day">Day ${i}</div>
          <div class="amt">${amount}</div>
          ${claimed ? '<div class="tick">‚úî</div>' : ''}
        </div>`;
    }
    if (tilesEl) tilesEl.innerHTML = html;
  }

  async function refreshUser(){
    try{
      const r = await fetch('/api/user/get');
      const j = await r.json();
      if (!j.ok) return;

      // saldo
      if (balEl && j.user && j.user.balance != null){
        balEl.textContent = `$${Number(j.user.balance).toFixed(2)}`;
      }

      // state check-in (disable tombol kalau sudah klaim hari ini)
      const last = j.user?.last_checkin ? String(j.user.last_checkin).slice(0,10) : null;
      const today = new Date().toISOString().slice(0,10);
      const already = (last === today);
      if (btn){
        btn.disabled = !!already;
        if (btnTxt) btnTxt.textContent = already ? 'Sudah di-claim' : 'Claim Bonus';
        if (already) btn.classList.add('is-claimed'); else btn.classList.remove('is-claimed');
      }
      renderTiles(j.user?.streak || 0, already);

      // REF % ‚Üí ubah semua teks "25%"
      const rp = Number(j.ref_percent || 10);
      const badge = document.querySelector('.ref-badge');
      if (badge) badge.textContent = `${rp}%`;
      const homeMut = document.querySelector('.home-ref-card .muted');
      if (homeMut) homeMut.textContent = `Get ${rp}% of their earnings`;
      const heroP = document.querySelector('.ref-hero p.muted');
      if (heroP) heroP.innerHTML = `Earn <strong>${rp}%</strong> of your friends earnings for life!`;
    }catch{}
  }

  if (btn){
    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      btn.disabled = true;
      try{
        const r = await fetch('/api/checkin/claim', { method:'POST' });
        const j = await r.json();
        if (!j.ok){
          btn.disabled = false;
          return toast(j.error || 'Claim gagal');
        }
        // update cepat dari response
        if (balEl && j.balance != null) balEl.textContent = `$${Number(j.balance).toFixed(2)}`;
        if (btnTxt) btnTxt.textContent = j.already ? 'Sudah di-claim' : 'Claimed!';
        btn.classList.add('is-claimed');
        // rerender tile sesuai day terbaru
        renderTiles(j.streak || j.day || 0, true);
      }catch(e){
        btn.disabled = false;
        toast('Failed to reach server');
      }
    });
  }

  // initial
  refreshUser();
})();
</script>

  <script src="./app.js" defer></script>
</body>
</html>
